{
  "title": "Sign In With Solana (SIWS) Integration",
  "created_at": "2025-12-04",
  "status": "completed",
  "summary": "Implement Sign In With Solana (SIWS) as a new authentication method in authkit, following the Solana Wallet Standard for wallet-based authentication.",

  "background": {
    "what_is_siws": "SIWS is a standardized authentication protocol for Solana wallets, modeled after EIP-4361 (Sign In With Ethereum). It replaces the clunky 'connect + signMessage' flow with a single 'signIn' method that returns a standardized message format and Ed25519 signature.",
    "key_benefits": [
      "Domain binding prevents phishing attacks",
      "Standardized message format enables wallet scrutiny",
      "Replay attack prevention via nonce and timestamps",
      "No transaction costs - pure authentication",
      "First-class support in Solana Wallet Standard and Wallet Adapter"
    ],
    "message_format": {
      "example": "[domain] wants you to sign in with your Solana account:\n[address]\n\n[statement]\n\nURI: [uri]\nVersion: [version]\nChain ID: [chain-id]\nNonce: [nonce]\nIssued At: [issued-at]\nExpiration Time: [expiration-time]",
      "required_fields": ["domain", "address"],
      "optional_fields": ["statement", "uri", "version", "chainId", "nonce", "issuedAt", "expirationTime", "notBefore", "requestId", "resources"]
    },
    "verification_process": {
      "steps": [
        "1. Frontend requests signIn input from backend (nonce, domain, etc.)",
        "2. Wallet constructs message following ABNF specification",
        "3. User approves/signs the message",
        "4. Frontend sends signed output to backend",
        "5. Backend verifies Ed25519 signature against message",
        "6. Backend validates message fields (nonce, domain, timestamps)",
        "7. On success, backend issues JWT tokens"
      ]
    }
  },

  "architecture_analysis": {
    "current_auth_methods": [
      "Password (email/phone + password with Argon2id hashing)",
      "OIDC/OAuth2 (Google, Apple, Discord)",
      "Email verification codes",
      "SMS verification codes (Twilio)",
      "2FA (email/SMS based)"
    ],
    "existing_patterns": {
      "provider_linkage": "user_providers table stores (issuer, provider_slug, subject, email_at_provider)",
      "session_management": "Server-side refresh sessions with family tracking for replay detection",
      "token_issuance": "IssueAccessToken() + IssueRefreshSession() pattern",
      "handler_pattern": "Gin handlers call core.Service methods, use ginutil for responses"
    },
    "key_extension_points": {
      "core_service": "Add Solana wallet login methods to core/service.go",
      "providers_table": "Store wallet as provider with issuer='solana:mainnet' or similar",
      "handlers": "Add new handlers in adapters/gin/handlers/",
      "routes": "Register routes in adapters/gin/service.go"
    }
  },

  "implementation_plan": {
    "phase_1_core_siws": {
      "title": "Phase 1: Core SIWS Support",
      "status": "not_started",
      "tasks": [
        {
          "id": "1.1",
          "name": "Add Solana verification package",
          "description": "Create siws/ package with Ed25519 signature verification and SIWS message parsing",
          "files_to_create": [
            "siws/siws.go - Core types (SolanaSignInInput, SolanaSignInOutput)",
            "siws/message.go - Message construction following ABNF spec",
            "siws/verify.go - Ed25519 signature verification using crypto/ed25519",
            "siws/parse.go - Parse signed message back to structured fields"
          ],
          "dependencies": ["crypto/ed25519 (stdlib)", "github.com/mr-tron/base58 (for public key encoding)"],
          "status": "not_started"
        },
        {
          "id": "1.2",
          "name": "Add nonce generation and storage",
          "description": "Generate cryptographically secure nonces and store them for verification",
          "approach": "Use existing StateCache pattern from OIDC - Redis-backed with in-memory fallback",
          "files_to_modify": [
            "storage/redis/siws_nonce.go - Redis nonce cache",
            "storage/memory/siws_nonce.go - In-memory fallback"
          ],
          "nonce_requirements": {
            "length": "Minimum 8 alphanumeric characters (SIWS spec)",
            "ttl": "15 minutes (matches OIDC state TTL)",
            "single_use": "Delete after successful verification"
          },
          "status": "not_started"
        },
        {
          "id": "1.3",
          "name": "Add core service methods for Solana auth",
          "description": "Implement login/link methods in core/service.go",
          "methods_to_add": [
            "GenerateSIWSInput(ctx, domain, chainId) (*siws.Input, nonce, error)",
            "VerifySIWSAndLogin(ctx, input, output, extra) (token, expiresAt, refreshToken, error)",
            "LinkSolanaWallet(ctx, userID, input, output) error",
            "GetUserBySolanaAddress(ctx, address) (*dbUser, error)"
          ],
          "status": "not_started"
        },
        {
          "id": "1.4",
          "name": "Database schema for wallet addresses",
          "description": "Use existing user_providers table with Solana-specific values",
          "approach": "issuer='solana:mainnet', provider_slug='solana', subject=wallet_address (base58)",
          "migrations": "No new tables needed - reuse user_providers with new issuer/slug values",
          "optional_extension": "Add profiles.users.solana_address column for quick lookups (like discord_username)",
          "status": "not_started"
        }
      ]
    },

    "phase_2_http_handlers": {
      "title": "Phase 2: HTTP API Endpoints",
      "status": "not_started",
      "tasks": [
        {
          "id": "2.1",
          "name": "Implement challenge endpoint",
          "description": "POST /auth/solana/challenge - Request a sign-in challenge",
          "handler_file": "adapters/gin/handlers/solana_challenge_post.go",
          "request_body": {
            "address": "string (base58 public key)",
            "username": "string (optional, desired username for new accounts)",
            "chain_id": "string (optional, defaults to mainnet)"
          },
          "response_body": {
            "nonce": "string (8+ char alphanumeric)",
            "issued_at": "string (ISO 8601)",
            "expiration_time": "string (ISO 8601)",
            "domain": "string (from config or request origin)",
            "statement": "string (optional, configurable)",
            "chain_id": "string"
          },
          "server_side_storage": {
            "key": "nonce",
            "value": "{ address, username }",
            "ttl": "10 minutes",
            "note": "Username stored server-side with nonce, not in signed message. User can change username later via PATCH /auth/user/username"
          },
          "rate_limit": "30 per 10 minutes per IP",
          "status": "not_started"
        },
        {
          "id": "2.2",
          "name": "Implement verify/login endpoint",
          "description": "POST /auth/solana/login - Verify signature and authenticate",
          "handler_file": "adapters/gin/handlers/solana_login_post.go",
          "request_body": {
            "input": "SolanaSignInInput (the challenge)",
            "output": {
              "account": { "address": "base58 public key" },
              "signature": "base64 or hex Ed25519 signature",
              "signed_message": "base64 or hex message bytes"
            }
          },
          "response_body": {
            "access_token": "JWT",
            "refresh_token": "string",
            "expires_in": "number (seconds)",
            "token_type": "Bearer",
            "user": { "id": "uuid", "solana_address": "base58" }
          },
          "behavior": {
            "new_wallet": "Create new user with username from challenge request (or derived from address if not provided)",
            "existing_wallet": "Login to existing user (ignore username in challenge)",
            "linking": "Not handled here - separate endpoint"
          },
          "status": "not_started"
        },
        {
          "id": "2.3",
          "name": "Implement wallet linking endpoint",
          "description": "POST /auth/solana/link - Link Solana wallet to existing account",
          "handler_file": "adapters/gin/handlers/solana_link_post.go",
          "requires_auth": true,
          "request_body": {
            "input": "SolanaSignInInput",
            "output": "SolanaSignInOutput"
          },
          "response_body": {
            "success": true,
            "message": "Solana wallet linked successfully"
          },
          "behavior": {
            "already_linked_same_user": "Success (no-op)",
            "already_linked_other_user": "Error: wallet already linked to another account",
            "success": "Store wallet in user_providers"
          },
          "status": "not_started"
        },
        {
          "id": "2.4",
          "name": "Update user/me endpoint",
          "description": "Include Solana wallet in user profile response",
          "modify_file": "adapters/gin/handlers/user_me_get.go",
          "additions": {
            "solana_address": "base58 address if linked",
            "solana_verified": "true if address is verified via signature"
          },
          "status": "not_started"
        }
      ]
    },

    "phase_3_route_registration": {
      "title": "Phase 3: Route Registration & Configuration",
      "status": "not_started",
      "tasks": [
        {
          "id": "3.1",
          "name": "Register routes in service.go",
          "description": "Add Solana routes to GinRegisterAPI",
          "modify_file": "adapters/gin/service.go",
          "routes_to_add": [
            "POST /auth/solana/challenge",
            "POST /auth/solana/login",
            "POST /auth/solana/link (requires auth)"
          ],
          "status": "not_started"
        },
        {
          "id": "3.2",
          "name": "Add rate limit constants",
          "description": "Define rate limits for Solana endpoints",
          "modify_file": "adapters/ginutil/ratelimit.go",
          "constants_to_add": [
            "RLSolanaChallenge - 30/10min",
            "RLSolanaLogin - 20/10min",
            "RLSolanaLink - 12/hour"
          ],
          "status": "not_started"
        },
        {
          "id": "3.3",
          "name": "Add SIWS configuration options",
          "description": "Allow customization of SIWS behavior",
          "modify_file": "core/config.go",
          "options_to_add": {
            "SolanaEnabled": "bool - enable/disable Solana auth",
            "SolanaStatement": "string - custom statement in sign-in message",
            "SolanaChainID": "string - default chain ID (mainnet, devnet, etc.)",
            "SolanaChallengeTTL": "duration - how long challenges are valid"
          },
          "status": "not_started"
        }
      ]
    },

    "phase_4_testing": {
      "title": "Phase 4: Testing",
      "status": "not_started",
      "tasks": [
        {
          "id": "4.1",
          "name": "Unit tests for SIWS package",
          "description": "Test message construction, parsing, and verification",
          "files_to_create": [
            "siws/siws_test.go",
            "siws/message_test.go",
            "siws/verify_test.go"
          ],
          "test_vectors": "Use test vectors from Phantom's sign-in-with-solana repository",
          "status": "not_started"
        },
        {
          "id": "4.2",
          "name": "Integration tests for HTTP endpoints",
          "description": "Test full authentication flow",
          "files_to_create": [
            "testing/solana_auth_test.go"
          ],
          "scenarios": [
            "New wallet creates new user",
            "Existing wallet logs in",
            "Link wallet to account",
            "Replay attack prevention (reused nonce)",
            "Expired challenge rejection",
            "Invalid signature rejection",
            "Wrong domain rejection"
          ],
          "status": "not_started"
        }
      ]
    }
  },

  "technical_details": {
    "ed25519_verification": {
      "library": "crypto/ed25519 (Go stdlib)",
      "public_key_format": "32 bytes, base58-encoded for Solana addresses",
      "signature_format": "64 bytes, may be base64 or hex encoded from frontend",
      "verification_code_example": "ed25519.Verify(publicKey, message, signature)"
    },
    "message_construction": {
      "format": "ABNF specification from SIWS standard",
      "encoding": "UTF-8 string, then bytes for signing",
      "critical_fields": ["domain (prevents phishing)", "nonce (prevents replay)", "issuedAt (prevents stale attacks)"]
    },
    "provider_storage": {
      "table": "profiles.user_providers",
      "issuer": "solana:mainnet (or solana:devnet, solana:testnet)",
      "provider_slug": "solana",
      "subject": "Base58-encoded wallet public key",
      "profile": "Optional JSON with wallet metadata"
    },
    "username_derivation": {
      "strategy": "Use first/last 4 characters of address if not provided: 'u_AbCd...WxYz'",
      "collision_handling": "Append random suffix if username taken"
    },
    "nonce_storage": {
      "structure": "SIWSChallengeData { Address, Username, IssuedAt, ExpiresAt }",
      "key_format": "auth:siws:nonce:{nonce}",
      "storage": "Redis (with in-memory fallback)",
      "ttl": "15 minutes (matches OIDC state TTL)"
    }
  },

  "database_changes": {
    "new_tables": "None required",
    "explanation": "SIWS reuses existing infrastructure:",
    "reused_tables": {
      "profiles.users": "New users created with email=NULL, phone_number=NULL, solana wallet as only auth method",
      "profiles.user_providers": "Stores wallet link with issuer='solana:mainnet', provider_slug='solana', subject=base58_address"
    },
    "optional_enhancement": {
      "column": "profiles.users.solana_address",
      "purpose": "Quick lookup without joining user_providers (like discord_username column)",
      "required": false
    }
  },

  "security_considerations": [
    {
      "threat": "Replay attacks",
      "mitigation": "Single-use nonces stored in Redis/memory, deleted after verification"
    },
    {
      "threat": "Phishing (fake domain)",
      "mitigation": "Domain binding in message, validated server-side against expected issuer"
    },
    {
      "threat": "Stale challenges",
      "mitigation": "issuedAt validation within 10-minute window (Phantom standard)"
    },
    {
      "threat": "Signature forgery",
      "mitigation": "Ed25519 cryptographic verification using stdlib crypto/ed25519"
    },
    {
      "threat": "Account takeover via wallet linking",
      "mitigation": "Require existing authentication before linking wallet"
    }
  ],

  "frontend_integration_guide": {
    "dependencies": [
      "@solana/wallet-adapter-react",
      "@solana/wallet-adapter-wallets",
      "@solana/wallet-standard-features"
    ],
    "flow": [
      "1. Request challenge from POST /auth/solana/challenge",
      "2. Use wallet.signIn(input) method (Phantom, Solflare, etc.)",
      "3. Send output to POST /auth/solana/login",
      "4. Store received tokens (same as OIDC flow)"
    ],
    "example_code": {
      "note": "Example TypeScript code for frontend integration",
      "request_challenge": "const { nonce, ...input } = await fetch('/auth/solana/challenge', { method: 'POST', body: JSON.stringify({ address }) })",
      "sign_in": "const output = await wallet.signIn(input)",
      "verify_login": "const { access_token, refresh_token } = await fetch('/auth/solana/login', { method: 'POST', body: JSON.stringify({ input, output }) })"
    }
  },

  "estimated_files": {
    "new_files": [
      "siws/siws.go",
      "siws/message.go",
      "siws/verify.go",
      "siws/parse.go",
      "siws/siws_test.go",
      "storage/redis/siws_nonce.go",
      "storage/memory/siws_nonce.go",
      "adapters/gin/handlers/solana_challenge_post.go",
      "adapters/gin/handlers/solana_login_post.go",
      "adapters/gin/handlers/solana_link_post.go",
      "testing/solana_auth_test.go"
    ],
    "modified_files": [
      "core/service.go - Add Solana auth methods",
      "core/config.go - Add Solana configuration",
      "adapters/gin/service.go - Register routes",
      "adapters/ginutil/ratelimit.go - Add rate limit keys",
      "adapters/gin/handlers/user_me_get.go - Include Solana address",
      "go.mod - Add base58 dependency"
    ]
  },

  "dependencies_to_add": [
    {
      "package": "github.com/mr-tron/base58",
      "purpose": "Base58 encoding/decoding for Solana addresses",
      "alternative": "github.com/btcsuite/btcutil/base58"
    }
  ],

  "references": [
    {
      "name": "Phantom SIWS Specification",
      "url": "https://github.com/phantom/sign-in-with-solana"
    },
    {
      "name": "Phantom Developer Docs",
      "url": "https://phantom.com/learn/developers/sign-in-with-solana"
    },
    {
      "name": "Solana Wallet Standard",
      "url": "https://github.com/solana-labs/wallet-standard"
    },
    {
      "name": "EIP-4361 (Sign In With Ethereum)",
      "url": "https://eips.ethereum.org/EIPS/eip-4361"
    },
    {
      "name": "Go Ed25519 Package",
      "url": "https://pkg.go.dev/crypto/ed25519"
    }
  ]
}
